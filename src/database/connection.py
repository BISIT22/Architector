"""
Модуль для работы с базой данных (SQLite)
Автор: Алексей Марышев
"""

import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker, Session
from sqlalchemy.ext.declarative import declarative_base
from dotenv import load_dotenv
from loguru import logger

load_dotenv()

DATABASE_URL = os.getenv("DATABASE_URL", "sqlite:///data/architect.db")

engine = create_engine(DATABASE_URL, connect_args={"check_same_thread": False})
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    """Создание сессии для работы с БД"""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def _seed_database(db: Session):
    """Наполнение БД тестовыми данными"""
    from .operations import DatabaseOperations
    from .models import GenerationRequest, RequestType

    db_ops = DatabaseOperations(db)

    if db.query(GenerationRequest).count() > 0:
        logger.info("База данных уже содержит данные. Наполнение не требуется.")
        return

    logger.info("База данных пуста. Добавляем 10 тестовых запросов...")

    test_prompts = [
        {
            "input_prompt": "Запрос для обучения модели 'Киберпанк-Архитектор': Создай неоновый, многоуровневый рынок в трущобах мегаполиса будущего. Добавь голографические вывески, хаотичные кабели и элементы азиатской архитектуры.",
            "style": "Киберпанк",
            "materials": ["неон", "хром", "бетон", "старые провода"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Эльфийский Зодчий': Спроектируй парящий в воздухе дворец из живого, переплетенного дерева и светящегося кристалла. Структура должна быть элегантной, с плавными линиями и водопадами.",
            "style": "Фэнтези / Органическая архитектура",
            "materials": ["живое дерево", "кристалл", "лунный камень"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Паровой Инженер': Сконструируй часовую башню в стиле стимпанк. Используй множество открытых шестерней, медных труб и манометров. Башня должна периодически испускать пар.",
            "style": "Стимпанк",
            "materials": ["медь", "латунь", "кирпич", "закаленное стекло"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Древний Конструктор': Воссоздай библиотеку в Александрийском стиле, но внутри гигантской пещеры с подземной рекой. Источником света служат светящиеся грибы и кристаллы.",
            "style": "Античность / Фэнтези",
            "materials": ["мрамор", "песчаник", "дерево", "светящиеся грибы"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Подводный Строитель': Спроектируй подводный исследовательский комплекс с прозрачными куполами, соединенными туннелями. Вокруг должна быть морская флора и фауна.",
            "style": "Футуризм / Био-тек",
            "materials": ["армированное стекло", "титан", "био-люминесцентные полимеры"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Пустынный Кочевник': Создай город, вырезанный в скалах каньона, похожий на Петру. Здания соединены веревочными мостами, на верхних плато разбиты сады.",
            "style": "Древняя / Скальная архитектура",
            "materials": ["красный песчаник", "дерево", "ткань"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Мастер Дзен': Спроектируй минималистичный японский храм на вершине горы. Включает в себя сад камней, пруд с карпами кои и ворота-тории на входе.",
            "style": "Японский минимализм / Дзен",
            "materials": ["темное дерево", "бамбук", "рисовая бумага", "галька"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Кондитер': Создай пряничный замок в стиле барокко. Башни из вафельных рожков, стены из имбирного печенья, окна из леденцов и река из горячего шоколада.",
            "style": "Сказочный / Барокко",
            "materials": ["пряник", "глазурь", "карамель", "шоколад"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Космический Скиталец': Спроектируй заброшенную космическую станцию на астероиде, частично поглощенную кристаллическими инопланетными наростами.",
            "style": "Научная-фантастика / Хоррор",
            "materials": ["обшивка корабля", "сталь", "светящиеся кристаллы"]
        },
        {
            "input_prompt": "Запрос для обучения модели 'Современный Классик': Создай современную виллу, интерпретирующую принципы архитектуры Фрэнка Ллойда Райта. Используй консольные балконы, горизонтальные линии и интеграцию с природой.",
            "style": "Органическая архитектура / Модернизм",
            "materials": ["бетон", "дерево", "камень", "стекло"]
        }
    ]

    for i, prompt_data in enumerate(test_prompts):
        try:
            db_ops.create_generation_request(
                input_prompt=prompt_data["input_prompt"],
                style=prompt_data["style"],
                materials=prompt_data["materials"],
                request_type=RequestType.TEXT_GENERATION,
                user_session_id="test_data_seed"
            )
            logger.info(f"Добавлен тестовый запрос {i+1}/{len(test_prompts)}")
        except Exception as e:
            logger.error(f"Не удалось добавить тестовый запрос {i+1}: {e}")

    logger.info("Тестовые данные успешно добавлены.")


def init_db():
    """Инициализация базы данных"""
    logger.info("Инициализация базы данных...")
    # Импортируем модели, чтобы они были зарегистрированы в Base
    from . import models
    Base.metadata.create_all(bind=engine)
    logger.info("База данных успешно инициализирована.")
    
    # Добавляем тестовые данные, если их нет
    logger.info("Проверка на наличие тестовых данных...")
    db = next(get_db())
    try:
        _seed_database(db)
    finally:
        db.close()

if __name__ == "__main__":
    init_db()